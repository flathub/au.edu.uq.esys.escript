{
    "app-id": "au.edu.uq.esys.escript",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "24.08",
    "sdk": "org.freedesktop.Sdk",
    "command": "run-escript",
    "finish-args": [
        "--filesystem=home",
        "--share=network",
        "--share=ipc",
        "--device=dri",
        "--socket=fallback-x11",
        "--socket=wayland",
        "--env=PATH=/var/data/python/bin:/app/bin:/usr/bin"
    ],
    "modules": [
        "python3-modules.json",
        {
            "name": "proj",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DBUILD_TESTING=OFF"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/OSGeo/PROJ.git",
                    "tag": "9.4.1",
                    "commit": "875a485fa5ef435c57f7682f904dd31ca92253ab"
                }
            ]
        },
        {
            "name": "cython-pyproj",
            "buildsystem": "simple",
            "build-commands": [
                "pip3 install --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} cython"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://files.pythonhosted.org/packages/7f/a2/fd5ced5dd33597ef291861bfadd46820de417b41bcb6ca2fa0b5f6fa8152/Cython-3.0.0.tar.gz",
                    "sha256": "350b18f9673e63101dbbfcf774ee2f57c20ac4636d255741d76ca79016b1bd82"
                }
            ]
        },
        {
            "name": "pyproj",
            "buildsystem": "simple",
            "build-commands": [
                "python3 setup.py build",
                "python3 setup.py install --prefix=/app --root=/ --optimize=1"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/pyproj4/pyproj.git",
                    "tag": "3.6.1",
                    "commit": "0c5159aab8c32488584ae472b3752203f1005559"
                }
            ]
        },
        {
            "name": "boost",
            "buildsystem": "simple",
            "build-commands": [
                "./bootstrap.sh --prefix=/app/ --with-libraries=locale,filesystem,system,date_time,regex,program_options --with-icu --with-python-version=3.12 --with-toolset=gcc",
                "./b2 headers",
                "./b2 -j$FLATPAK_BUILDER_N_JOBS install variant=release cxxstd=17 --layout=system"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://downloads.sourceforge.net/boost/boost/1.87.0/boost_1_87_0.tar.bz2",
                    "sha256": "af57be25cb4c4f4b413ed692fe378affb4352ea50fbe294a11ef548f4d527d89"
                }
            ]
        },
        {
            "name": "zlib",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/madler/zlib.git",
                    "tag": "v1.3.1",
                    "commit": "51b7f2abdade71cd9bb0e7a373ef2610ec6f9daf"
                }
            ]
        },
        {
            "name": "openmpi-trilinos-hdf5-netcdf",
            "sources": [
                {
                    "type": "archive",
                    "url":  "https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-5.0.6.tar.bz2",
                    "sha256": "bd4183fcbc43477c254799b429df1a6e576c042e74a2d2f8b37d537b2ff98157"
                }
            ]
        },
        {
            "name": "hdf5",
            "buildsystem": "cmake-ninja",
            "subdir": "hdf5-1.14.5",
            "build-options": {
                "env": {
                    "CXX": "mpicxx",
                    "CC": "mpicc",
                    "FC": "mpif90",
                    "F9X": "mpif90",
                    "RUNPARALLEL": "mpirun",
                    "OMPI_MCA_disable_memory_allocator": "1"
                }
            },
            "config-opts": [
                "-DHDF5_ENABLE_Z_LIB_SUPPORT:BOOL=ON",
                "-DCMAKE_BUILD_TYPE=Release",
                "-DALLOW_UNSUPPORTED=ON",
                "-DBUILD_STATIC_LIBS=OFF",
                "-DHDF5_BUILD_HL_LIB=ON",
                "-DHDF5_BUILD_CPP_LIB=ON",
                "-DHDF5_ENABLE_PARALLEL=ON",
                "-DHDF5_ENABLE_SZIP_SUPPORT=ON",
                "-DHDF5_ENABLE_SZIP_ENCODING=ON",
                "-DUSE_LIBAEC=ON"
            ],
            "builddir": true,
            "sources": [
                {
                    "type": "archive",
                    "url": "https://support.hdfgroup.org/releases/hdf5/v1_14/v1_14_5/downloads/hdf5-1.14.5.tar.gz",
                    "sha256": "ec2e13c52e60f9a01491bb3158cb3778c985697131fc6a342262d32a26e58e44"
                }
            ]
        },
        {
            "name": "netcdf-c",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_INSTALL_LIBDIR=lib",
                "-DENABLE_CDF5=ON",
                "-DCMAKE_BUILD_TYPE=Release"
            ],
            "build-options":{
                "env": {
                    "CC": "mpicc"
                }
            },
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/Unidata/netcdf-c/archive/refs/tags/v4.9.2.tar.gz",
                    "sha256": "bc104d101278c68b303359b3dc4192f81592ae8640f1aee486921138f7f88cb7"
                }
            ]
        },
        {
            "name": "netcdf-cxx",
            "sources": [
                {
                    "type": "archive",
                    "url":  "https://github.com/Unidata/netcdf-cxx4/archive/refs/tags/v4.3.1.tar.gz",
                    "sha256": "e3fe3d2ec06c1c2772555bf1208d220aab5fee186d04bd265219b0bc7a978edc"
                }
            ]
        },
        {
            "name": "gmsh",
            "buildsystem": "cmake",
            "config-opts": [
                "-DDEFAULT=0",
                "-DENABLE_BUILD_LIB=1",
                "-DENABLE_POST=1",
                "-DENABLE_PARSER=1"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://gmsh.info/src/gmsh-4.11.1-source.tgz",
                    "sha256": "c5fe1b7cbd403888a814929f2fd0f5d69e27600222a18c786db5b76e8005b365"
                }
            ]
        },
        {
            "name": "pip",
            "buildsystem": "simple",
            "build-commands": [
                "install -Dm755 pip.pyz -t /app/bin/"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://bootstrap.pypa.io/pip/pip.pyz",
                    "sha256": "c59df64b826d5baa978829fd1e1b3ea2e748f73dce7cce58d09aa28a1c9323a7"
                }
            ]
        },
        {
            "name": "lapack-trilinos",
            "builddir": true,
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DBUILD_SHARED_LIBS=ON",
                "-DBUILD_TESTING=OFF",
                "-DLAPACKE=ON",
                "-DCBLAS=ON"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v3.12.0.tar.gz",
                    "sha256": "eac9570f8e0ad6f30ce4b963f4f033f0f643e7c3912fc9ee6cd99120675ad48b"
                }
            ]
        },
        {
            "name": "openblas-trilinos",
            "buildsystem": "cmake-ninja",
            "builddir": true,
            "config-opts": [
                "-DBUILD_TESTING:BOOL=OFF",
                "-DDYNAMIC_ARCH:BOOL=ON"
            ],
            "cleanup": ["/include/openblas"],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/xianyi/OpenBLAS/releases/download/v0.3.28/OpenBLAS-0.3.28.tar.gz",
                    "sha256": "f1003466ad074e9b0c8d421a204121100b0751c96fc6fcf3d1456bd12f8a00a1"
                }
            ]
        },
        {
            "name": "GKlib-METIS",
            "buildsystem": "simple",
            "build-commands": [
                "make config cc=gcc prefix=/app/ openmp=set",
                "make",
                "make install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/KarypisLab/GKlib.git",
                    "commit": "8bd6bad750b2b0d90800c632cf18e8ee93ad72d7"
                }
            ]
        },
        {
            "name": "METIS-trilinos",
            "buildsystem": "simple",
            "build-commands": [
                "make config shared=1 cc=gcc prefix=/app/",
                "make install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/KarypisLab/METIS.git",
                    "commit": "e0f1b88b8efcb24ffa0ec55eabb78fbe61e58ae7"
                }
            ]
        },
        {
            "name": "suitesparse-trilinos",
            "buildsystem": "cmake-ninja",
            "config-opts":[
                "-DBUILD_STATIC_LIBS=OFF",
                "-DBUILD_SHARED_LIBS=ON",
                "-DSUITESPARSE_ENABLE_PROJECTS=cholmod;umfpack;colamd;cxsparse"
            ],
            "cleanup":[
                "/bin",
                "/include",
                "/lib/cmake",
                "/lib/*.a",
                "/lib/*.la",
                "/lib/pkgconfig",
                "/share/man"
            ],
            "sources": [{
                "type": "git",
                "url": "https://github.com/DrTimothyAldenDavis/SuiteSparse.git",
                "tag": "v7.8.3",
                "commit": "d3c4926d2c47fd6ae558e898bfc072ade210a2a1"
            }]
        },
        {
            "name": "scalapack-trilinos",
            "buildsystem": "simple",
            "build-options": {
                "cflags": "-Wno-implicit-function-declaration",
                "env": {
                    "LDFLAGS": "-L/app/lib -L/app/lib64"
                }
            },
            "build-commands":[
                "mkdir BUILD",
                "cd BUILD && cmake -DCMAKE_Fortran_FLAGS:STRING=\"$FCFLAGS -fallow-argument-mismatch\" -DCMAKE_BUILD_TYPE:STRING=Release -DCMAKE_Fortran_COMPILER=/app/bin/mpifort -DBUILD_SHARED_LIBS:BOOL=ON -DCMAKE_CXX_COMPILER=/app/bin/mpic++ -DCMAKE_C_COMPILER=/app/bin/mpicc -DCMAKE_INSTALL_PREFIX=/app/ ..",
                "cd BUILD && make",
                "cd BUILD && make install"
            ],
            "post-install": [
                "install -m 644 -D PBLAS/SRC/*.h /app/include",
                "install -m 644 -D BLACS/SRC/*.h /app/include"
            ],
            "sources": [{
                "type": "git",
                "url": "https://github.com/Reference-ScaLAPACK/scalapack.git",
                "tag": "v2.2.1"
            }]
        },
        {
            "name": "trilinos",
            "buildsystem": "simple",
            "build-options": {
                "env": {
                    "LDFLAGS": "-L/app/lib -L/app/lib64"
                }
            },
            "build-commands":[
                "chmod +x cmake_trilinos",
                "./cmake_trilinos"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/trilinos/Trilinos.git",
                    "tag": "trilinos-release-16-0-0"
                },
                {
                    "type": "file",
                    "path": "cmake_trilinos"
                }
            ]
        },
        {
            "name": "escript",
            "buildsystem": "simple",
            "build-commands": [
                "ln -s /app/lib/python3.10/site-packages/numpy/core/include/numpy /app/include/",
                "ln -s /app/bin/pip.pyz /app/bin/pip",
                "scons options_file=scons/flatpak_options.py umfpack=0 trilinos=1 werror=0 silo=0 cxx_extra='-fPIC -Wno-psabi' -j`nproc --all`"
            ],
            "post-install" : [
                "install -Dm644 tools/flatpak/au.edu.uq.esys.escript.png /app/share/icons/hicolor/256x256/apps/au.edu.uq.esys.escript.png",
                "install -Dm644 tools/flatpak/au.edu.uq.esys.escript.desktop /app/share/applications/au.edu.uq.esys.escript.desktop",
                "install -Dm644 au.edu.uq.esys.escript.appdata.xml /app/share/appdata/au.edu.uq.esys.escript.appdata.xml"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/LutzGross/esys-escript.github.io.git",
                    "tag": "6.0.0",
                    "commit": "001bfeef67d69d460e36c32859e3e8edeee281c4"
                },
                {
                    "type": "patch",
                    "path": "flatpak_options.py.patch"
                },
                {
                    "type": "file",
                    "path": "au.edu.uq.esys.escript.appdata.xml"
                }
            ]
        }
    ]
}
